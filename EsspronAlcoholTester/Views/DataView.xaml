<UserControl x:Class="EsspronAlcoholTester.Views.DataView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="900">
    
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </UserControl.Resources>
    
    <StackPanel>
        <!-- Stats Summary -->
        <Grid Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <Border Grid.Column="0" Style="{StaticResource CardStyle}" Margin="0,0,12,0">
                <StackPanel>
                    <TextBlock Text="Filtered Results" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"/>
                    <TextBlock Text="{Binding DataContext.TestRecords.Count, RelativeSource={RelativeSource AncestorType=UserControl}, FallbackValue=0}" 
                               FontSize="28" FontWeight="Bold" Foreground="{StaticResource TextPrimaryBrush}"/>
                </StackPanel>
            </Border>
            
            <Border Grid.Column="1" Style="{StaticResource CardStyle}" Margin="6,0">
                <StackPanel>
                    <TextBlock Text="Passed" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"/>
                    <TextBlock Text="{Binding DataContext.PassedTests, RelativeSource={RelativeSource AncestorType=UserControl}, FallbackValue=0}" 
                               FontSize="28" FontWeight="Bold" Foreground="#22C55E"/>
                </StackPanel>
            </Border>
            
            <Border Grid.Column="2" Style="{StaticResource CardStyle}" Margin="6,0">
                <StackPanel>
                    <TextBlock Text="Warning" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"/>
                    <TextBlock Text="{Binding DataContext.WarningTests, RelativeSource={RelativeSource AncestorType=UserControl}, FallbackValue=0}" 
                               FontSize="28" FontWeight="Bold" Foreground="#F59E0B"/>
                </StackPanel>
            </Border>
            
            <Border Grid.Column="3" Style="{StaticResource CardStyle}" Margin="12,0,0,0">
                <StackPanel>
                    <TextBlock Text="Failed" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"/>
                    <TextBlock Text="{Binding DataContext.FailedTests, RelativeSource={RelativeSource AncestorType=UserControl}, FallbackValue=0}" 
                               FontSize="28" FontWeight="Bold" Foreground="#EF4444"/>
                </StackPanel>
            </Border>
        </Grid>
        
        <!-- Filters Card -->
        <Border Style="{StaticResource CardStyle}" Margin="0,0,0,24">
            <StackPanel>
                <TextBlock Text="Filters" FontSize="16" FontWeight="SemiBold" 
                           Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,16"/>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Date Range -->
                    <StackPanel Grid.Column="0" Margin="0,0,12,0">
                        <TextBlock Text="Start Date" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,6"/>
                        <DatePicker SelectedDate="{Binding StartDate}" Height="40"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="1" Margin="6,0">
                        <TextBlock Text="End Date" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,6"/>
                        <DatePicker SelectedDate="{Binding EndDate}" Height="40"/>
                    </StackPanel>
                    
                    <!-- Result Filter -->
                    <StackPanel Grid.Column="2" Margin="6,0,12,0">
                        <TextBlock Text="Result" FontSize="12" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,6"/>
                        <ComboBox ItemsSource="{Binding FilterOptions}" SelectedItem="{Binding SelectedFilter}" 
                                  Height="40" FontSize="13"/>
                    </StackPanel>
                    
                    <!-- Clear Filters -->
                    <Button Grid.Column="3" Content="Clear Filters" 
                            Style="{StaticResource SecondaryButtonStyle}"
                            VerticalAlignment="Bottom" Height="40"/>
                </Grid>
                
                <!-- Search -->
                <Grid Margin="0,16,0,0">
                    <TextBox Style="{StaticResource ModernTextBoxStyle}" Height="44"
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             Tag="Search by Subject ID, Device Name, or Notes..."/>
                    <TextBlock Text="ðŸ”" FontSize="18" HorizontalAlignment="Right" VerticalAlignment="Center" 
                               Margin="0,0,16,0" IsHitTestVisible="False" Foreground="{StaticResource TextSecondaryBrush}"/>
                </Grid>
            </StackPanel>
        </Border>
        
        <!-- Data Grid Card -->
        <Border Style="{StaticResource CardStyle}">
            <StackPanel>
                <Grid Margin="0,0,0,16">
                    <TextBlock Text="Test Records" FontSize="18" FontWeight="SemiBold" 
                               Foreground="{StaticResource TextPrimaryBrush}"/>
                    <Button Content="ðŸ“¤ Export to CSV" 
                            Style="{StaticResource PrimaryButtonStyle}"
                            HorizontalAlignment="Right" Padding="16,8"/>
                </Grid>
                
                <DataGrid ItemsSource="{Binding DataContext.TestRecords, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                          Style="{StaticResource ModernDataGridStyle}"
                          ColumnHeaderStyle="{StaticResource ModernDataGridColumnHeaderStyle}"
                          CellStyle="{StaticResource ModernDataGridCellStyle}"
                          MaxHeight="500">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="#" Binding="{Binding Id}" Width="60"/>
                        <DataGridTextColumn Header="Test Date &amp; Time" Binding="{Binding TestTime, StringFormat={}{0:MMM dd, yyyy HH:mm}}" Width="160"/>
                        <DataGridTextColumn Header="Subject ID" Binding="{Binding SubjectId}" Width="120"/>
                        <DataGridTextColumn Header="Alcohol Level" Binding="{Binding FormattedAlcoholLevel}" Width="130"/>
                        <DataGridTemplateColumn Header="Result" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Border CornerRadius="4" Padding="10,5"
                                            Background="{Binding ResultStatus, Converter={StaticResource ResultBackgroundConverter}}">
                                        <TextBlock Text="{Binding ResultStatus}" FontSize="12" FontWeight="SemiBold"
                                                   Foreground="{Binding ResultStatus, Converter={StaticResource ResultForegroundConverter}}"
                                                   HorizontalAlignment="Center"/>
                                    </Border>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Device" Binding="{Binding DeviceName}" Width="180"/>
                        <DataGridTextColumn Header="Imported" Binding="{Binding ImportedAt, StringFormat={}{0:MMM dd, HH:mm}}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
                
                <!-- Empty State -->
                <Border Background="#F8FAFC" CornerRadius="12" Padding="40" 
                        Visibility="{Binding DataContext.TestRecords.Count, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource EmptyStateVisibilityConverter}, FallbackValue=Visible}">
                    <StackPanel HorizontalAlignment="Center">
                        <TextBlock Text="ðŸ“Š" FontSize="48" HorizontalAlignment="Center"/>
                        <TextBlock Text="No test records found" FontSize="16" FontWeight="SemiBold" 
                                   Foreground="{StaticResource TextPrimaryBrush}" Margin="0,16,0,4" HorizontalAlignment="Center"/>
                        <TextBlock Text="Import data from your device to see test records here" 
                                   FontSize="13" Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>
    </StackPanel>
</UserControl>
